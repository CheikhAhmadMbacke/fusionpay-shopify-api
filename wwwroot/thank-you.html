<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement Réussi - AfroKingVap</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .success-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .success-icon {
            font-size: 80px;
            color: #10b981;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        h1 {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .receipt-container {
            background: #f9fafb;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            border: 2px solid #e5e7eb;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7c3aed;
        }

        .receipt-title {
            font-size: 1.8rem;
            color: #1f2937;
            font-weight: 600;
        }

        .receipt-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .detail-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

            .detail-group h3 {
                color: #4f46e5;
                margin-bottom: 15px;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 10px;
            }

                .detail-group h3 i {
                    font-size: 1.2rem;
                }

        .detail-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            color: #6b7280;
            font-weight: 500;
        }

        .detail-value {
            color: #1f2937;
            font-weight: 600;
            text-align: right;
        }

        .total-amount {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 30px 0;
        }

        .total-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .amount {
            font-size: 3rem;
            font-weight: bold;
        }

        .buttons-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }

            .btn-primary:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(37, 211, 102, 0.3);
            }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            border: 2px solid #d1d5db;
        }

            .btn-secondary:hover {
                background: #e5e7eb;
                transform: translateY(-3px);
            }

        .whatsapp-notice {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            display: none; /* Caché par défaut */
        }

        .whatsapp-icon {
            color: #25d366;
            font-size: 2rem;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: #9ca3af;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .payment-status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-paid {
            background-color: #10b981;
            color: white;
        }

        .status-pending {
            background-color: #f59e0b;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .receipt-details {
                grid-template-columns: 1fr;
            }

            .buttons-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-header">
            <div class="success-icon">✅</div>
            <h1>Paiement Réussi !</h1>
            <p class="subtitle">Merci pour votre commande chez AfroKingVap</p>
        </div>

        <div class="receipt-container">
            <div class="receipt-header">
                <div class="logo">AFROKINGVAP</div>
                <div class="receipt-title">Confirmation de Commande</div>
            </div>

            <div class="receipt-details">
                <div class="detail-group">
                    <h3><i>📋</i> Informations Commande</h3>
                    <div class="detail-item">
                        <span class="detail-label">N° Commande:</span>
                        <span class="detail-value" id="orderId">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date:</span>
                        <span class="detail-value" id="orderDate">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Référence:</span>
                        <span class="detail-value" id="reference">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Zone Livraison:</span>
                        <span class="detail-value" id="deliveryZone">Chargement...</span>
                    </div>
                </div>

                <div class="detail-group">
                    <h3><i>👤</i> Informations Client</h3>
                    <div class="detail-item">
                        <span class="detail-label">Nom:</span>
                        <span class="detail-value" id="customerName">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Téléphone:</span>
                        <span class="detail-value" id="customerPhone">Chargement...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Adresse:</span>
                        <span class="detail-value" id="customerAddress">Chargement...</span>
                    </div>
                </div>

                <div class="detail-group">
                    <h3><i>💳</i> Détails Paiement</h3>
                    <div class="detail-item">
                        <span class="detail-label">Statut:</span>
                        <span class="detail-value">
                            <span id="status">Payé</span>
                            <span class="payment-status-badge status-paid" id="statusBadge">PAYÉ</span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Méthode:</span>
                        <span class="detail-value" id="paymentMethod">Mobile Money</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Transaction ID:</span>
                        <span class="detail-value" id="transactionNumber">Chargement...</span>
                    </div>
                </div>
            </div>

            <div class="total-amount">
                <div class="total-label">Montant Total Payé</div>
                <div class="amount" id="amount">0 XOF</div>
                <div style="margin-top: 10px; font-size: 1rem;">
                    <span id="productsAmount">Produits: 0 XOF</span> •
                    <span id="deliveryAmount">Livraison: 0 XOF</span>
                </div>
            </div>

            <!-- NOUVEAU : Section pour envoyer sur WhatsApp -->
            <div class="whatsapp-notice" id="whatsappSection">
                <div class="whatsapp-icon">📱</div>
                <div>
                    <strong>Envoyez votre commande sur WhatsApp</strong><br>
                    Cliquez sur le bouton ci-dessous pour informer AfroKingVap de votre commande.
                </div>
            </div>
        </div>

        <!-- Boutons mis à jour -->
        <div class="buttons-container">
            <button class="btn btn-primary" id="sendWhatsAppBtn">
                <i>📱</i> Envoyer commande sur WhatsApp
            </button>
            <button class="btn btn-secondary" onclick="returnToStore()">
                <i>🏪</i> Retourner sur le Site
            </button>
        </div>

        <div class="footer">
            <p>Merci de votre confiance ! Pour toute question, contactez notre service client.</p>
            <p>© 2025 AfroKingVap - Tous droits réservés</p>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const WHATSAPP_NUMBER = '221781802575';
        let currentOrderData = null;

        // ===== FONCTIONS UTILITAIRES =====
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const paramsObj = {};

            paramsObj.orderId = params.get('orderId') || 'N/A';
            paramsObj.amount = params.get('amount') || '0';
            paramsObj.token = params.get('token') || 'N/A';
            paramsObj.orderNumber = params.get('orderNumber') || paramsObj.orderId;
            paramsObj.email = params.get('email') || '';
            paramsObj.customer = decodeURIComponent(params.get('customer') || 'Client');
            paramsObj.phone = params.get('phone') || '';
            paramsObj.currency = params.get('currency') || 'XOF';
            paramsObj.timestamp = params.get('timestamp') || new Date().toISOString().split('T')[0];
            paramsObj.deliveryZone = params.get('deliveryZone') || '';
            paramsObj.deliveryPrice = params.get('deliveryPrice') || '0';
            paramsObj.paymentMethod = params.get('paymentMethod') || 'mobile';

            paramsObj.customer = paramsObj.customer.replace(/%20/g, ' ').replace(/%2520/g, ' ');

            return paramsObj;
        }

        function formatCurrency(amount) {
            const numAmount = parseInt(amount) || 0;
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'XOF',
                minimumFractionDigits: 0
            }).format(numAmount);
        }

        function formatDate(dateString) {
            try {
                if (dateString.includes('T')) {
                    return new Date(dateString).toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    const year = dateString.substring(0, 4);
                    const month = dateString.substring(4, 6);
                    const day = dateString.substring(6, 8);
                    const hour = dateString.substring(8, 10);
                    const minute = dateString.substring(10, 12);

                    return `${day}/${month}/${year} à ${hour}:${minute}`;
                }
            } catch (e) {
                return new Date().toLocaleDateString('fr-FR');
            }
        }

        // ===== RÉCUPÉRATION DES DONNÉES DE COMMANDE =====
        async function loadOrderData(orderId) {
            try {
                // Essayer de récupérer depuis localStorage
                const storedData = localStorage.getItem('afrokingvap_order_' + orderId);
                if (storedData) {
                    return JSON.parse(storedData);
                }

                // Sinon, récupérer depuis les paramètres URL
                const params = getUrlParams();
                return {
                    orderId: orderId,
                    customer: {
                        name: params.customer,
                        phone: params.phone,
                        address: ''
                    },
                    delivery: {
                        zone: params.deliveryZone,
                        price: parseInt(params.deliveryPrice) || 0
                    },
                    payment: {
                        method: params.paymentMethod,
                        status: 'paid'
                    },
                    totals: {
                        products: parseInt(params.amount) - parseInt(params.deliveryPrice),
                        delivery: parseInt(params.deliveryPrice) || 0,
                        total: parseInt(params.amount)
                    },
                    products: [
                        {
                            title: 'Commande AfroKingVap',
                            price: formatCurrency(params.amount),
                            quantity: 1
                        }
                    ],
                    timestamp: params.timestamp
                };
            } catch (error) {
                console.error('Erreur chargement données:', error);
                return null;
            }
        }

        // ===== GÉNÉRATION MESSAGE WHATSAPP =====
        function generateWhatsAppMessage(orderData) {
            let message = `Bonjour AfroKingVap ! Je viens de finaliser mon paiement pour la commande suivante :\n\n`;
            message += `📦 COMMANDE N° ${orderData.orderId}\n\n`;

            message += `📋 DÉTAILS DE LA COMMANDE\n`;
            if (orderData.products && orderData.products.length > 0) {
                orderData.products.forEach((item, index) => {
                    message += `${index + 1}. ${item.title} x${item.quantity} (${item.price})\n`;
                });
            } else {
                message += `Commande AfroKingVap\n`;
            }

            message += `\n💰 DÉTAILS FINANCIERS\n`;
            message += `• Total produits: ${formatCurrency(orderData.totals.products)}\n`;
            message += `• Frais livraison (${orderData.delivery.zone}): ${formatCurrency(orderData.totals.delivery)}\n`;
            message += `• Total payé: ${formatCurrency(orderData.totals.total)}\n\n`;

            message += `👤 INFORMATIONS CLIENT\n`;
            message += `• Nom: ${orderData.customer.name}\n`;
            message += `• Téléphone: +221${orderData.customer.phone}\n`;
            message += `• Zone livraison: ${orderData.delivery.zone}\n`;
            if (orderData.customer.address) {
                message += `• Adresse détaillée: ${orderData.customer.address}\n`;
            }

            message += `\n💳 PAIEMENT\n`;
            message += `• Méthode: ${orderData.payment.method === 'mobile' ? 'MOBILE MONEY' : 'CASH'}\n`;
            message += `• Statut: PAIEMENT EFFECTUÉ ✅\n`;
            message += `• Transaction sécurisée\n\n`;

            message += `🆔 RÉFÉRENCE\n`;
            message += `• Date: ${formatDate(orderData.timestamp)}\n`;
            message += `• ID Commande: ${orderData.orderId}\n\n`;

            message += `📞 SUPPORT: +221 78 192 97 20\n`;
            message += `🏪 AFROKINGVAP - Vape & Accessoires`;

            return message;
        }

        // ===== OUVERTURE WHATSAPP =====
        function openWhatsAppWithMessage(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;

            // Ouvrir dans un nouvel onglet
            window.open(whatsappUrl, '_blank');

            // Feedback utilisateur
            const whatsappBtn = document.getElementById('sendWhatsAppBtn');
            const originalText = whatsappBtn.innerHTML;
            whatsappBtn.innerHTML = '<i>✅</i> Message envoyé !';
            whatsappBtn.disabled = true;

            setTimeout(() => {
                whatsappBtn.innerHTML = originalText;
                whatsappBtn.disabled = false;
            }, 3000);
        }

        // ===== MISE À JOUR DE L'INTERFACE =====
        async function updateUI() {
            const params = getUrlParams();

            // Récupérer les données complètes
            currentOrderData = await loadOrderData(params.orderId);

            if (!currentOrderData) {
                console.error('Données de commande non trouvées');
                return;
            }

            // Mettre à jour les éléments
            document.getElementById('orderId').textContent = currentOrderData.orderId;
            document.getElementById('orderDate').textContent = formatDate(currentOrderData.timestamp);
            document.getElementById('reference').textContent = params.token.substring(0, 16) + '...';
            document.getElementById('deliveryZone').textContent = currentOrderData.delivery.zone;
            document.getElementById('customerName').textContent = currentOrderData.customer.name;
            document.getElementById('customerPhone').textContent = currentOrderData.customer.phone || 'Non renseigné';
            document.getElementById('customerAddress').textContent = currentOrderData.customer.address || 'Non renseigné';
            document.getElementById('amount').textContent = formatCurrency(currentOrderData.totals.total);
            document.getElementById('productsAmount').textContent = `Produits: ${formatCurrency(currentOrderData.totals.products)}`;
            document.getElementById('deliveryAmount').textContent = `Livraison: ${formatCurrency(currentOrderData.totals.delivery)}`;
            document.getElementById('paymentMethod').textContent = currentOrderData.payment.method === 'mobile' ? 'Mobile Money' : 'Cash';
            document.getElementById('transactionNumber').textContent = params.token;

            // Afficher la section WhatsApp
            document.getElementById('whatsappSection').style.display = 'flex';

            document.title = `Paiement Réussi - ${formatCurrency(currentOrderData.totals.total)}`;
        }

        // ===== GESTION ÉVÉNEMENTS =====
        document.getElementById('sendWhatsAppBtn').addEventListener('click', function () {
            if (currentOrderData) {
                const message = generateWhatsAppMessage(currentOrderData);
                openWhatsAppWithMessage(message);
            } else {
                alert('Les données de commande ne sont pas disponibles. Veuillez réessayer.');
            }
        });

        function returnToStore() {
            window.location.href = 'https://afrokingvap.com';
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', async function () {
            await updateUI();

            // Auto-send après 3 secondes (optionnel)
            // setTimeout(() => {
            //     if (currentOrderData && confirm('Voulez-vous envoyer automatiquement votre commande sur WhatsApp ?')) {
            //         const message = generateWhatsAppMessage(currentOrderData);
            //         openWhatsAppWithMessage(message);
            //     }
            // }, 3000);
        });
    </script>
</body>
</html>
